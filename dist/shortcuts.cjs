"use strict";var e=require("@peter.naydenov/notice");var t={_normalizeWithPlugins:function(e,t){return function(e){const n=t.shortcuts;Object.keys(n).forEach(t=>{Object.entries(n[t]).forEach(([r,i])=>{const o=e(r);o!==r&&(delete n[t][r],n[t][o]=i)})})}},_readShortcutWithPlugins:function(e,t){return function(n){const{inAPI:r}=e,i=n.split(":")[0].toLowerCase().trim(),o=r._systemAction(i,"none");let s=n;return-1!==o&&(s=t.plugins[o].shortcutName(n)),s}},_setupPlugin:function(e,t){const{inAPI:n}=e,{currentContext:r,shortcuts:i,exposeShortcut:o,ERROR_EVENT_NAME:s}=t;return function(t){const{prefix:c,_normalizeShortcutName:u,_registerShortcutEvents:l,_listenDOM:a,pluginState:f,deps:m}=t,{resetState:p}=m;f.currentContext=r,f.shortcuts=i,f.exposeShortcut=o,f.ERROR_EVENT_NAME=s;const d={ev:e.ev,extra:e.extra,...m};n._normalizeWithPlugins(u);let h=l(d,f),g=a(d,f);h>0&&g.start();let v={getPrefix:()=>c,shortcutName:e=>u(e),contextChange:()=>{p(),h=l(d,f),h<1&&g.stop(),h>0&&g.start()},mute:()=>g.stop(),unmute:()=>g.start(),destroy:()=>{g.stop(),p()}};return Object.freeze(v),v}},_systemAction:function(e,t){return function(e,n,r=null){return t.plugins.findIndex(t=>t.getPrefix()===e&&(t[n]&&t[n](r),!0))}},changeContext:function(e,t){const{shortcuts:n,currentContext:r,ERROR_EVENT_NAME:i}=t,{ev:o}=e;return function(e=!1){const s=r.name;if(!e)return o.reset(),void(r.name=null);s!==e&&(n[e]?(n[s]&&o.reset(),r.name=e,t.plugins.forEach(t=>t.contextChange(e)),Object.entries(n[e]).forEach(([e,t])=>{e.includes(":SETUP")||t.forEach(t=>o.on(e,t))}),o.on("*",(...e)=>{t.exposeShortcut&&t.exposeShortcut(...e)})):o.emit(i,`Context '${e}' does not exist`))}},listShortcuts:function(e,t){const n=t.shortcuts;return function(e=null){if(null!=e){let t=n[e];return null==t?null:Object.entries(t).map(([e,t])=>e)}return Object.keys(n).map(e=>{let t={};return t.context=e,t.shortcuts=Object.entries(n[e]).map(([e,t])=>e),t})}},load:function(e,t){const{shortcuts:n,plugins:r}=t,{API:{changeContext:i,getContext:o}}=e;return function(e){const t=o(),s=r.map(e=>e.getPrefix().toUpperCase());let c=!1;Object.entries(e).forEach(([e,i])=>{e===t&&(c=!0),n[e]={},Object.entries(i).forEach(([t,i])=>{let o=t,c=t.toUpperCase().trim(),u=s.map((e,t)=>c.startsWith(e)?t:null).filter(e=>null!==e);if(u.length){let e=u[0];o=r[e].shortcutName(t)}i instanceof Function&&(i=[i]),n[e][o]=i})}),c&&(i(),i(t))}},unload:function(e,t){const{currentContext:n,shortcuts:r,ERROR_EVENT_NAME:i}=t,{ev:o}=e;return function(e){n.name!==e?r[e]?delete r[e]:o.emit(i,`Context '${e}' does not exist`):o.emit(i,`Context '${e}' can't be removed during is current active context. Change the context first`)}}};function n(e,t){const{ev:n,_specialChars:r,_readKeyEvent:i,extra:o,resetState:s}=e,{currentContext:c,streamKeys:u,listenOptions:l}=t,{keyWait:a}=l;let f=[],m=null,p=!0,d=!1;const h=()=>p=!1,g=()=>p=!0,v=()=>d=!0,x=()=>!1===p;function E(){let e=f.map(e=>[e.join("+")]);const r={wait:h,end:g,ignore:v,isWaiting:x,note:c.note,context:c.name,dependencies:o,type:"key"};if(!p){let t=`KEY:${e.at(-1).join("+")}`;n.emit(t,r),d&&(f=f.slice(0,-1),d=!1)}if(p){const i=`KEY:${e.join(",")}`;n.emit(i,r),d&&(f=f.slice(0,-1),d=!1),f=[],clearTimeout(t.keyIgnore),t.keyIgnore=null,clearTimeout(m),m=null}}function O(n){if(clearTimeout(m),r().hasOwnProperty(n.code))return f.push(i(n,r)),u&&u({key:n.key,context:c.name,note:c.note,dependencies:e.extra}),t.keyIgnore?(clearTimeout(t.keyIgnore),t.keyIgnore=setTimeout(()=>t.keyIgnore=null,a),void f.pop()):p&&f.length===t.maxSequence?(E(),void(t.keyIgnore=setTimeout(()=>t.keyIgnore=null,a))):void(p?m=setTimeout(E,a):E())}function y(n){if(!r().hasOwnProperty(n.code)){if(clearTimeout(m),u&&u({key:n.key,context:c.name,note:c.note,dependencies:e.extra}),t.keyIgnore)return clearTimeout(t.keyIgnore),void(t.keyIgnore=setTimeout(()=>t.keyIgnore=null,a));if(f.push(i(n,r)),p&&f.length===t.maxSequence)return E(),void(t.keyIgnore=setTimeout(()=>t.keyIgnore=null,a));p?m=setTimeout(E,a):E()}}return{start:function(){t.active||(document.addEventListener("keydown",O),document.addEventListener("keypress",y),t.active=!0)},stop:function(){t.active&&(document.removeEventListener("keydown",O),document.removeEventListener("keypress",y),t.active=!1,m&&(clearTimeout(m),m=null),t.keyIgnore&&(clearTimeout(t.keyIgnore),t.keyIgnore=null),f=[],p=!0,d=!1)}}}function r(e){const t=e.toUpperCase(),n=/KEY\s*\:/i.test(t),r=t.indexOf(":");if(!n)return e;return`KEY:${t.slice(r+1).split(",").map(e=>e.trim()).map(e=>e.split("+").map(e=>e.trim()).sort().join("+")).join(",")}`}function i(e,t){let{shiftKey:n,altKey:r,ctrlKey:i}=e,o=t(),s=e.code.replace("Key","").replace("Digit",""),c=[];return i&&c.push("CTRL"),n&&c.push("SHIFT"),r&&c.push("ALT"),o.hasOwnProperty(s)?c.push(o[s].toUpperCase()):["ControlLeft","ControlRight","ShiftLeft","ShiftRight","AltLeft","AltRight","Meta"].includes(s)||c.push(s.toUpperCase()),c.sort()}function o(e,t){let n=0,r=!1;const i=t.defaultOptions,{regex:o}=e,{currentContext:{name:s},shortcuts:c}=t;return null==s?0:(Object.entries(c[s]).forEach(([s,c])=>{if(!o.test(s))return;if("KEY:SETUP"===s){r=!0;let n=c.reduce((n,r)=>{let i=r({dependencies:e.extra,defaults:structuredClone(t.defaultOptions)});return Object.assign(n,i)},i);return void Object.assign(t.listenOptions,n)}n++;let u=s.slice(4).split(",").length;t.maxSequence<u&&(t.maxSequence=u)}),r||Object.assign(t.listenOptions,i),n)}function s(){return{ArrowLeft:"LEFT",ArrowUp:"UP",ArrowRight:"RIGHT",ArrowDown:"DOWN",Enter:"ENTER",NumpadEnter:"ENTER",Escape:"ESC",Backspace:"BACKSPACE",Space:"SPACE",Tab:"TAB",Backquote:"`",BracketLeft:"[",BracketRight:"]",Equal:"=",Slash:"/",Backslash:"\\",IntlBackslash:"`",F1:"F1",F2:"F2",F3:"F3",F4:"F4",F5:"F5",F6:"F6",F7:"F7",F8:"F8",F9:"F9",F10:"F10",F11:"F11",F12:"F12"}}function c(e,t,n){const{listenOptions:{clickTarget:r}}=t;let i=n;return i===document.body?null:i.dataset[r]||"A"===i.nodeName?i:c(e,t,i.parentNode)}function u(e,t){const{ev:n,_findTarget:r,_readClickEvent:i,extra:o,resetState:s}=e,{listenOptions:c,currentContext:u}=t,{mouseWait:l}=c;let a=null,f=null,m=null,p=null,d=0;function h(){if(!a)return;const e=i(f,d),t={target:a,targetProps:a.getBoundingClientRect(),x:f.clientX,y:f.clientY,context:u.name,note:u.note,event:f,dependencies:o,type:"click"};n.emit(e,t),m=null,p=null,a=null,f=null,d=0}function g(n){let i=c.maxLeftClicks;if(clearTimeout(m),p)return clearTimeout(p),void(p=setTimeout(()=>p=null,l));if(a=r(e,t,n.target),null!=a){if(a&&a.dataset.hasOwnProperty("quickClick")&&(i=1),a&&"A"===a.tagName&&(i=1),f=n,d++,d>=i)return h(),void(i>1&&(p=setTimeout(()=>p=null,l)));m=setTimeout(h,l)}}function v(n){let i=c.maxRightClicks;if(clearTimeout(m),p)return clearTimeout(p),void(p=setTimeout(()=>p=null,l));if(a=r(e,t,n.target),null!=a){if(a&&a.dataset.hasOwnProperty("quickClick")&&(i=1),a&&"A"===a.tagName&&(i=1),f=n,d++,d>=i)return h(),void(i>1&&(p=setTimeout(()=>p=null,l)));m=setTimeout(h,l)}}return{start:function(){t.active||(window.addEventListener("contextmenu",v),document.addEventListener("click",g),t.active=!0)},stop:function(){t.active&&(window.removeEventListener("contextmenu",v),document.removeEventListener("click",g),t.active=!1,m&&(clearTimeout(m),m=null),p&&(clearTimeout(p),p=null),a=null,f=null,d=0)}}}function l(e){const t=e.toUpperCase(),n=/CLICK\s*\:/i.test(t),r=["LEFT","MIDDLE","RIGHT"],i=["ALT","SHIFT","CTRL"];let o=null,s=[],c=0,u=t.indexOf(":");return n?(t.slice(u+1).trim().split("-").map(e=>e.trim()).forEach(e=>{r.includes(e)?o=e:i.includes(e)?s.push(e):isNaN(e)||(c=e)}),`CLICK:${o}-${c}${s.length>0?"-":""}${s.sort().join("-")}`):e}function a(e,t){let{shiftKey:n,altKey:r,ctrlKey:i,key:o,button:s}=e,c=`CLICK:${["LEFT","MIDDLE","RIGHT"][s]}-${t}`,u=[];return i&&u.push("CTRL"),n&&u.push("SHIFT"),r&&u.push("ALT"),u.length>0?`${c}${u.length>0?"-":""}${u.sort().join("-")}`:`${c}`}function f(e,t){let n=0,r=!1;const i=t.defaultOptions,{regex:o}=e,{listenOptions:s,currentContext:{name:c},shortcuts:u}=t;return null==c||(Object.entries(u[c]).forEach(([c,u])=>{if(!o.test(c))return;if("CLICK:SETUP"===c){r=!0;let n=u.reduce((n,r)=>{let i=r({dependencies:e.extra,defaults:structuredClone(t.defaultOptions)});return Object.assign(n,i)},i);return void Object.assign(t.listenOptions,n)}n++;let[l,a]=c.slice(6).split("-");"LEFT"===l&&s.maxLeftClicks<a&&(s.maxLeftClicks=a),"RIGHT"===l&&s.maxRightClicks<a&&(s.maxRightClicks=a)}),r||Object.assign(t.listenOptions,i)),n}function m(e,t){const{ev:n}=e;let r=null;function i(e,t,n,r){return{target:n.target,context:t.currentContext.name,note:t.currentContext.note,event:n,dependencies:e.extra,type:r}}function o(r){const{callbacks:o,typeFn:s}=t;r.target;const c=i(e,t,r,"form-in"),u=`${s(c)}/in`;null!=o[u]&&n.emit(u,c,o[u])}function s(r){const{callbacks:o,typeFn:s}=t,c=i(e,t,r,"form-out"),u=`${s(c)}/out`;null!=o[u]&&n.emit(u,c,o[u])}function c(o){const{callbacks:s,typeFn:c}=t,u=i(e,t,o,"form-instant"),l=c(u),a=t.wait[`${l}`],f=`${l}/instant`;if(null==s[f])return;if(0===a)return void n.emit(f,u,s[f]);clearTimeout(r),r=setTimeout(()=>n.emit(f,u,s[f]),a)}return{start:function(){t.active||(document.addEventListener("focusin",o),document.addEventListener("focusout",s),document.addEventListener("input",c),t.active=!0)},stop:function(){t.active&&(document.removeEventListener("focusin",o),document.removeEventListener("focusout",s),document.removeEventListener("input",c),t.active=!1,r&&(clearTimeout(r),r=null))}}}function p(e){const t=e.toUpperCase(),n=/FORM\s*\:/i.test(t),r=t.indexOf(":");if(!n)return e;return`FORM:${t.slice(r+1).trim()}`}function d(e,t){const{regex:n,_defaults:r,ev:i}=e,{currentContext:{name:o},shortcuts:s,callbacks:c,ERROR_EVENT_NAME:u}=t;let l=[],a=[],f=[],m=0;if(null==o)return!1;if(Object.entries(s[o]).forEach(([e,t])=>{n.test(e)&&("FORM:WATCH"===e&&(l=t),"FORM:DEFINE"===e&&(a=t),"FORM:ACTION"===e&&(f=t))}),0===f.length)return m;let p=new Set;0===a.length&&(a=[r.define]),0===l.length&&(l=[r.watch]);let d=l.map(t=>t({dependencies:e.extra})).reduce((e,t)=>(e.push(t),e),[]);return t.watchList=document.querySelectorAll(d),t.watchList.forEach(t=>p.add(a[0]({dependencies:e.extra,target:t}))),t.typeFn=a[0]?a[0]:r.define,f.forEach(n=>{if(!(n instanceof Function))return i.emit(u,"The 'form:action' should be a function."),!1;let r=n({dependencies:e.extra});if(!(r instanceof Array))return i.emit(u,"Warning: The 'form:action' function should RETURN an array."),!1;r.forEach(({fn:e,type:n,timing:r,wait:o=0})=>{if(p.has(n)&&e instanceof Function){let t=`${n}/${r}`;const o=c.hasOwnProperty(t);o?c[t].push(e):c[t]=[e],o||i.on(t,(e,t)=>{t.forEach(t=>{t instanceof Function&&t(e)})})}"instant"===r&&(t.wait[`${n}`]=o)})}),m=Object.keys(t.callbacks).length,m}const h={watch:()=>"input, select, textarea, button, a",define:({target:e})=>"checkbox"===e.type||"radio"===e.type?"checkbox":"button"==e.type||"submit"==e.type?"button":"input"};function g(e,t,n){const{listenOptions:{hoverTarget:r}}=t;let i=n;return i!==document&&(i!==document.body&&(i.dataset[r]?i:g(e,t,i.parentNode)))}function v(e,t){const{ev:n,_findTarget:r,resetState:i,extra:o}=e;function s(i){const s=i.clientX,c=i.clientY;let{hovered:u,hoverRectangle:l,listenOptions:a,hoverTimer:f,leaveTimer:m,lastEvent:p,lastHoverTarget:d}=t,h=r(e,t,i.target);if(function(e,t,n){return!!e&&t>=e.left&&t<=e.right&&n>=e.top&&n<=e.bottom}(l,s,c))return;const g={target:h,context:t.currentContext.name,note:t.currentContext.note,event:i,dependencies:o,type:"hover"};if(h!==u){if(u){if(t.hovered=!1,t.hoverRectangle=null,f)return clearTimeout(f),void(t.hoverTimer=null);if("off"===p)return;return void(t.leaveTimer=setTimeout(()=>{n.emit("HOVER:OFF",g),t.leaveTimer=null,t.lastEvent="off"},a.wait))}if(clearTimeout(m),clearTimeout(f),t.hovered=h,t.hoverRectangle=h.getBoundingClientRect(),h){if("on"===p&&d===h)return;t.hoverTimer=setTimeout(()=>{n.emit("HOVER:ON",g),t.hoverTimer=null,t.lastHoverTarget=h,t.lastEvent="on"},a.wait)}}}return{start:function(){t.active||(document.addEventListener("mousemove",s),t.active=!0)},stop:function(){t.active&&(document.removeEventListener("mousemove",s),i())}}}function x(e){const t=e.toUpperCase(),n=/HOVER\s*\:/i.test(t);let r=t.indexOf(":");return n?`HOVER:${t.slice(r+1).trim()}`:e}function E(e,t){let n=0,r=!1;const i=t.defaultOptions,{regex:o,_defaults:s,ev:c}=e,{currentContext:{name:u},shortcuts:l,ERROR_EVENT_NAME:a}=t;return null==u||(Object.entries(l[u]).forEach(([s,c])=>{if(o.test(s)){if("HOVER:SETUP"===s){r=!0;let n=c.reduce((n,r)=>{let i=r({dependencies:e.extra,defaults:structuredClone(t.defaultOptions)});return Object.assign(n,i)},i);return void Object.assign(t.listenOptions,n)}n++}}),r||Object.assign(t.listenOptions,i)),n}function O(e,t){const{ev:n,resetState:r,extra:i}=e;let o=null,s=null;function c(e){e.clientX,e.clientY;const{lastPosition:r,lastDirection:c,listenOptions:u,currentContext:l}=t,{scrollWait:a,endScrollWait:f,minSpace:m}=u;if(!r)return;let p=null,d=window.scrollX,h=window.scrollY;if(Math.abs(h-r.y)<m)return;p=h>r.y?"down":"up";const g=()=>({x:d,y:h,direction:p,context:l.name,note:l.note,dependencies:i,type:"scroll"}),v=`SCROLL:${p.toUpperCase()}`;clearTimeout(o),clearTimeout(s),o=setTimeout(()=>n.emit(v,g()),a),s=setTimeout(()=>n.emit("SCROLL:END",g()),f),t.lastPosition={x:d,y:h},t.lastDirection=p}return{start:function(){t.active||(t.lastPosition={x:window.scrollX,y:window.scrollY},window.addEventListener("scroll",c),t.active=!0)},stop:function(){t.active&&(window.removeEventListener("scroll",c),r())}}}function y(e){const t=e.toUpperCase(),n=/SCROLL\s*\:/i.test(t);let r=t.indexOf(":");return n?`SCROLL:${t.slice(r+1).trim()}`:e}function T(e,t){let n=0,r=!1;const i=t.defaultOptions,{regex:o}=e,{currentContext:{name:s},shortcuts:c}=t;return null==s||(Object.entries(c[s]).forEach(([s,c])=>{if(o.test(s)){if("SCROLL:SETUP"===s){r=!0;let n=c.reduce((n,r)=>{let i=r({dependencies:e.extra,defaults:structuredClone(t.defaultOptions)});return Object.assign(n,i)},i);return void Object.assign(t.listenOptions,n)}n++}}),r||Object.assign(t.listenOptions,i)),n}exports.pluginClick=function(e,t={}){let n={_findTarget:c,_readClickEvent:a,regex:/CLICK\s*\:/i},r={active:!1,defaultOptions:{mouseWait:320,clickTarget:"click"},listenOptions:{mouseWait:320,maxLeftClicks:1,maxRightClicks:1,clickTarget:"click"},streamKeys:!(!t.streamKeys||"function"!=typeof t.streamKeys)&&t.streamKeys};return n.resetState=function(){},e({prefix:"click",_normalizeShortcutName:l,_registerShortcutEvents:f,_listenDOM:u,pluginState:r,deps:n})},exports.pluginForm=function(e,t={}){let n={_defaults:h,regex:/FORM\s*\:/i},r={callbacks:{},typeFn:"",watchList:[],wait:{}};return n.resetState=function(){r.callbacks={},r.typeFn="",r.watchList=[],r.wait={}},e({prefix:"form",_normalizeShortcutName:p,_registerShortcutEvents:d,_listenDOM:m,pluginState:r,deps:n})},exports.pluginHover=function(e,t={}){let n={_findTarget:g,regex:/HOVER\s*\:/i},r={active:!1,hovered:!1,hoverRectangle:null,hoverTimer:null,leaveTimer:null,lastEvent:"",lastHoverTarget:null,defaultOptions:{hoverTarget:"hover",wait:320},listenOptions:{hoverTarget:"hover",wait:320}};return n.resetState=function(){r.active=!1,r.hovered=!1,r.hoverRectangle=null,clearTimeout(r.hoverTimer),clearTimeout(r.leaveTimer),r.hoverTimer=null,r.leaveTimer=null,r.lastHoverTarget=null},e({prefix:"hover",_normalizeShortcutName:x,_registerShortcutEvents:E,_listenDOM:v,pluginState:r,deps:n})},exports.pluginKey=function(e,t={}){let c={_specialChars:s,_readKeyEvent:i,regex:/KEY\s*\:/i},u={active:!1,maxSequence:1,keyIgnore:null,defaultOptions:{keyWait:480},listenOptions:{keyWait:480},streamKeys:!(!t.streamKeys||"function"!=typeof t.streamKeys)&&t.streamKeys};return c.resetState=function(){u.active=!1,u.keyIgnore=null,u.maxSequence=1},e({prefix:"key",_normalizeShortcutName:r,_registerShortcutEvents:o,_listenDOM:n,pluginState:u,deps:c})},exports.pluginScroll=function(e,t={}){let n={regex:/SCROLL\s*\:/i},r={active:!1,lastPosition:null,lastDirection:null,defaultOptions:{scrollWait:50,endScrollWait:400,minSpace:40},listenOptions:{scrollWait:50,endScrollWait:400,minSpace:40}};return n.resetState=function(){r.active=!1},e({prefix:"scroll",_normalizeShortcutName:y,_registerShortcutEvents:T,_listenDOM:O,pluginState:r,deps:n})},exports.shortcuts=function(n={}){let r={},i={};const o=e(),s={currentContext:{name:null,note:null},shortcuts:{},plugins:[],exposeShortcut:!(!n.onShortcut||"function"!=typeof n.onShortcut)&&n.onShortcut,ERROR_EVENT_NAME:n.errorEventName?n.errorEventName:"@shortcuts-error"};let c={ev:o,inAPI:r,API:i,extra:{}};return i.enablePlugin=(e,t={})=>{if("function"!=typeof e)return;let n=e(r._setupPlugin,t);const i=n.getPrefix(),o=r._systemAction(i,"none");-1===o?(s.plugins.push(n),n.unmute()):(n.destroy(),s.plugins[o].unmute())},i.disablePlugin=e=>{const t=r._systemAction(e,"destroy");-1!==t&&s.plugins.splice(t,1)},i.mutePlugin=e=>r._systemAction(e,"mute"),i.unmutePlugin=e=>r._systemAction(e,"unmute"),i.listPlugins=()=>s.plugins.map(e=>e.getPrefix()),i.getContext=()=>s.currentContext.name,i.getNote=()=>s.currentContext.note,i.setNote=(e=null)=>{"string"!=typeof e&&null!=e||(s.currentContext.note=e)},i.pause=(e="*")=>{let t=r._readShortcutWithPlugins(e);o.stop(t)},i.resume=(e="*")=>{const t=r._readShortcutWithPlugins(e);o.start(t)},i.emit=(e,...t)=>o.emit(r._readShortcutWithPlugins(e),...t),i.listContexts=()=>Object.keys(s.shortcuts),i.setDependencies=e=>Object.assign(c.extra,e),i.getDependencies=()=>c.extra,i.reset=function(){o.reset(),i.changeContext(),s.plugins.forEach(e=>e.destroy()),i.listContexts().map(e=>i.unload(e)),c.extra={},s.exposeShortcut=null},Object.entries(t).forEach(([e,t])=>{e.startsWith("_")?r[e]=t(c,s):i[e]=t(c,s)}),i};
