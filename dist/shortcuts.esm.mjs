import t from"@peter.naydenov/notice";var e={_normalizeWithPlugins:function(t,e){return function(t){const n=e.shortcuts;Object.keys(n).forEach((e=>{Object.entries(n[e]).forEach((([o,r])=>{const s=t(o);s!==o&&(delete n[e][o],n[e][s]=r)}))}))}},_systemAction:function(t,e){return function(t,n,o=null){return e.plugins.findIndex((e=>e.getPrefix()===t&&(e[n]&&e[n](o),!0)))}},changeContext:function(t,e){const{shortcuts:n,currentContext:o}=e,{ev:r}=t;return function(t=!1){const s=o.name;if(!t)return r.reset(),void(o.name=null);s!==t&&(n[t]?(n[s]&&r.reset(),o.name=t,e.plugins.forEach((e=>e.contextChange(t))),r.on("*",((t,...n)=>{e.exposeShortcut&&e.exposeShortcut(t,...n)}))):r.emit("@shortcuts-error",`Context '${t}' does not exist`))}},listShortcuts:function(t,e){const n=e.shortcuts;return function(t=null){if(null!=t){let e=n[t];return null==e?null:Object.entries(e).map((([t,e])=>t))}return Object.keys(n).map((t=>{let e={};return e.context=t,e.shortcuts=Object.entries(n[t]).map((([t,e])=>t)),e}))}},load:function(t,e){const{shortcuts:n,plugins:o}=e,{API:{changeContext:r,getContext:s}}=t;return function(t){const e=s(),i=o.map((t=>t.getPrefix().toUpperCase()));let c=!1;Object.entries(t).forEach((([t,r])=>{t===e&&(c=!0),n[t]={},Object.entries(r).forEach((([e,r])=>{let s=e,c=e.toUpperCase().trim(),u=i.map(((t,e)=>c.startsWith(t)?e:null)).filter((t=>null!==t));if(u.length){let t=u[0];s=o[t].shortcutName(e)}r instanceof Function&&(r=[r]),n[t][s]=r}))})),c&&(r(),r(e))}},unload:function(t,e){const{currentContext:n,shortcuts:o}=e,{ev:r}=t;return function(t){n.name!==t?o[t]?delete o[t]:r.emit("shortcuts-error",`Context '${t}' does not exist`):r.emit("shortcuts-error",`Context '${t}' can't be removed during is current active context. Change the context first`)}}};function n(t){const e=t.toUpperCase(),n=/KEY\s*\:/i.test(e),o=e.indexOf(":");if(!n)return t;return`KEY:${e.slice(o+1).split(",").map((t=>t.trim())).map((t=>t.split("+").map((t=>t.trim())).sort().join("+"))).join(",")}`}function o(t,e){let{shiftKey:n,altKey:o,ctrlKey:r}=t,s=t.code.replace("Key","").replace("Digit",""),i=[];return r&&i.push("CTRL"),n&&i.push("SHIFT"),o&&i.push("ALT"),e.hasOwnProperty(s)?i.push(e[s].toUpperCase()):["ControlLeft","ControlRight","ShiftLeft","ShiftRight","AltLeft","AltRight","Meta"].includes(s)||i.push(s.toUpperCase()),i.sort()}function r(t,e){let n=0;const{ev:o}=t,{listenOptions:r,currentContext:{name:s},shortcuts:i}=e;return null==s?0:(Object.entries(i[s]).forEach((([t,e])=>{if(!t.includes("KEY:"))return;n++;let s=t.slice(4).split(",").length;r.maxSequence<s&&(r.maxSequence=s),e.forEach((e=>o.on(t,e)))})),n)}function s(){return{ArrowLeft:"LEFT",ArrowUp:"UP",ArrowRight:"RIGHT",ArrowDown:"DOWN",Enter:"ENTER",NumpadEnter:"ENTER",Escape:"ESC",Backspace:"BACKSPACE",Space:"SPACE",Tab:"TAB",Backquote:"`",BracketLeft:"[",BracketRight:"]",Equal:"=",Slash:"/",Backslash:"\\",IntlBackslash:"`",F1:"F1",F2:"F2",F3:"F3",F4:"F4",F5:"F5",F6:"F6",F7:"F7",F8:"F8",F9:"F9",F10:"F10",F11:"F11",F12:"F12"}}function i(t,e,i={}){const{currentContext:c,shortcuts:u,exposeShortcut:l}=e,{inAPI:a}=t,m={ev:t.ev,_specialChars:s,_readKeyEvent:o},p={currentContext:c,shortcuts:u,active:!1,listenOptions:{keyWait:i.keyWait?i.keyWait:480,maxSequence:1,keyIgnore:null},streamKeys:!(!i.streamKeys||"function"!=typeof i.streamKeys)&&i.streamKeys,exposeShortcut:l};a._normalizeWithPlugins(n);let h=function(t,e){const{ev:n,_specialChars:o,_readKeyEvent:r}=t,{currentContext:s,streamKeys:i,listenOptions:c}=e,{keyWait:u}=c;let l=[],a=null,m=!0,p=!1;const h=()=>m=!1,f=()=>m=!0,d=()=>p=!0,g=()=>!1===m;function x(){let e=l.map((t=>[t.join("+")]));if(!m){let t=e.at(-1);n.emit(t,{wait:h,end:f,ignore:d,isWaiting:g,note:s.note,context:s.name,type:"key"}),p&&(e=e.slice(0,-1),p=!1)}const o={wait:h,end:f,ignore:d,isWaiting:g,note:s.note,context:s.name,dependencies:t.extra,type:"key"};if(m){const t=`KEY:${e.join(",")}`;n.emit(t,o),l=[],a=null}}function y(e){if(clearTimeout(a),o.hasOwnProperty(e.code))return l.push(r(e,o)),i&&i({key:e.key,context:s.name,note:s.note,dependencies:t.extra}),c.keyIgnore?(clearTimeout(c.keyIgnore),void(c.keyIgnore=setTimeout((()=>c.keyIgnore=null),u))):m&&l.length===c.maxSequence?(x(),void(c.keyIgnore=setTimeout((()=>c.keyIgnore=null),u))):void(m?a=setTimeout(x,u):x())}function C(e){if(!o.hasOwnProperty(e.code)){if(clearTimeout(a),i&&i({key:e.key,context:s.name,note:s.note,dependencies:t.extra}),c.keyIgnore)return clearTimeout(c.keyIgnore),void(c.keyIgnore=setTimeout((()=>c.keyIgnore=null),u));if(l.push(r(e,o)),m&&l.length===c.maxSequence)return x(),void(c.keyIgnore=setTimeout((()=>c.keyIgnore=null),u));m?a=setTimeout(x,u):x()}}return{start:function(){e.active||(document.addEventListener("keydown",y),document.addEventListener("keypress",C),e.active=!0)},stop:function(){e.active&&(document.removeEventListener("keydown",y),document.removeEventListener("keypress",C),e.active=!1)}}}(m,p),f=r(t,p);f>0&&h.start();const d={getPrefix:()=>"key",shortcutName:t=>n(t),contextChange:t=>{f=r(m,p),f<1&&h.stop(),f>0&&h.start()},mute:()=>h.stop(),unmute:()=>h.start(),destroy:()=>{h.stop(),p=null,d=null}};return Object.freeze(d),d}function c(t,e,n){const{listenOptions:{clickTarget:o}}=e;let r=n;return r===document||r===document.body?null:r.dataset[o]||"A"===r.nodeName?r:c(t,e,r.parentNode)}function u(t){const e=t.toUpperCase(),n=/CLICK\s*\:/i.test(e),o=["LEFT","MIDDLE","RIGHT"],r=["ALT","SHIFT","CTRL"];let s=null,i=[],c=0,u=e.indexOf(":");if(!n)return t;let l=e.slice(u+1).trim().split("-").map((t=>t.trim()));return console.log(l),l.forEach((t=>{o.includes(t)?s=t:r.includes(t)?i.push(t):isNaN(t)||(c=t)})),`CLICK:${s}-${c}${i.length>0?"-":""}${i.sort().join("-")}`}function l(t,e){let{shiftKey:n,altKey:o,ctrlKey:r,key:s,button:i}=t,c=`CLICK:${["LEFT","MIDDLE","RIGHT"][i]}-${e}`,u=[];return r&&u.push("CTRL"),n&&u.push("SHIFT"),o&&u.push("ALT"),u.length>0?`${c}${u.length>0?"-":""}${u.sort().join("-")}`:`${c}`}function a(t,e){let n=0;const{ev:o}=t,{listenOptions:r,currentContext:{name:s},shortcuts:i}=e;return null==s?0:(Object.entries(i[s]).forEach((([t,e])=>{if(!t.includes("CLICK:"))return;n++;let[,s]=t.slice(6).split("-");r.maxClicks<s&&(r.maxClicks=s),e.forEach((e=>o.on(t,e)))})),n)}function m(t,e,n){const{currentContext:o,shortcuts:r}=e,{inAPI:s}=t,i={ev:t.ev,_findTarget:c,_readClickEvent:l},m={currentContext:o,shortcuts:r,listenOptions:{mouseWait:n.mouseWait?n.mouseWait:320,maxClicks:1,clickTarget:n.clickTarget?n.clickTarget:"click"}};s._normalizeWithPlugins(u);let p=function(t,e){const{ev:n,_findTarget:o,_readClickEvent:r}=t,{listenOptions:s,currentContext:i}=e,{mouseWait:c}=s;let u=null,l=null,a=null,m=null,p=0;function h(){const e=r(l,p),o={target:u,targetProps:u?u.getBoundingClientRect():null,x:l.clientX,y:l.clientY,context:i.name,note:i.note,event:l,dependencies:t.extra,type:"click"};n.emit(e,o),a=null,m=null,u=null,l=null,p=0}function f(n){let r=s.maxClicks;return clearTimeout(a),m?(clearTimeout(m),void(m=setTimeout((()=>m=null),c))):(u=o(t,e,n.target),u&&u.dataset.hasOwnProperty("quickClick")&&(r=1),u&&"A"===u.tagName&&(r=1),l=n,p++,p>=r?(h(),void(r>1&&(m=setTimeout((()=>m=null),c)))):void(a=setTimeout(h,c)))}function d(n){let r=s.maxClicks;return clearTimeout(a),m?(clearTimeout(m),void(m=setTimeout((()=>m=null),c))):(u=o(t,e,n.target),u&&u.dataset.hasOwnProperty("quickClick")&&(r=1),u&&"A"===u.tagName&&(r=1),l=n,p++,p>=r?(h(),void(r>1&&(m=setTimeout((()=>m=null),c)))):void(a=setTimeout(h,c)))}return{start:function(){e.active||(window.addEventListener("contextmenu",d),document.addEventListener("click",f),e.active=!0)},stop:function(){e.active&&(window.removeEventListener("contextmenu",d),document.removeEventListener("click",f),e.active=!1)}}}(i,m),h=a(t,m);h>0&&p.start();const f={getPrefix:()=>"click",shortcutName:t=>u(t),contextChange:()=>{h=a(i,m),h<1&&p.stop(),h>0&&p.start()},mute:()=>p.stop(),unmute:()=>p.start(),destroy:()=>{p.stop(),m=null,f=null}};return Object.freeze(f),f}function p(n={}){const o=t(),r={},s={},i={currentContext:{name:null,note:null},shortcuts:{},plugins:[],exposeShortcut:!(!n.onShortcut||"function"!=typeof n.onShortcut)&&n.onShortcut},c={ev:o,inAPI:r,API:s,extra:{}};return o.on("@change-context",(t=>i.plugins.map((e=>e.contextChange(t))))),s.enable=(t,e={})=>{const n=t.name;if(-1===r._systemAction(n,"none")){let n;n=t(c,i,e),i.plugins.push(n)}},s.disable=t=>{const e=r._systemAction(t,"destroy");-1!==e&&(i.plugins=i.plugins.filter(((t,n)=>n!==e)))},s.mute=t=>r._systemAction(t,"mute"),s.unmute=t=>r._systemAction(t,"unmute"),s.getContext=()=>i.currentContext.name,s.getNote=()=>i.currentContext.note,s.setNote=(t=null)=>{"string"!=typeof t&&null!=t||(i.currentContext.note=t)},s.pause=(t="*")=>{let e=r._readWithPlugins(t);o.stop(e)},s.resume=(t="*")=>{const e=r._readWithPlugins(t);o.start(e)},s.emit=(t,...e)=>o.emit(r._readWithPlugins(t),c.extra,...e),s.listContexts=()=>Object.keys(i.shortcuts),s.setDependencies=t=>c.extra={...c.extra,...t},s.getDependencies=()=>c.extra,Object.entries(e).forEach((([t,e])=>{t.startsWith("_")?r[t]=e(c,i):s[t]=e(c,i)})),s}export{m as pluginClick,i as pluginKey,p as shortcuts};
